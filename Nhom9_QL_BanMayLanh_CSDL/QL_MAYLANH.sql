USE master
GO
DROP DATABASE QL_MAYLANH
GO

CREATE DATABASE QL_MAYLANH1
GO
USE QL_MAYLANH1
GO

CREATE TABLE NHASANXUAT
(
	MANSX NCHAR(15) NOT NULL,
	TENNSX NVARCHAR(30),
	CONSTRAINT PK_NHASANXUAT PRIMARY KEY (MANSX)
)

CREATE TABLE LOAISP
(
	MALOAI NCHAR(15) NOT NULL,
	TENLOAI NVARCHAR(30),
	MANSX NCHAR(15) NOT NULL,
	CONSTRAINT PK_LOAISP PRIMARY KEY (MALOAI),
	CONSTRAINT FK_LOAISP_MANSX FOREIGN KEY (MANSX) REFERENCES NHASANXUAT(MANSX)
)

CREATE TABLE SANPHAM
(
	MASP NCHAR(15) NOT NULL,
	TENSP NVARCHAR(30),
	DONGIA FLOAT,
	GIAGOC FLOAT,
	CONGSUAT NVARCHAR(30),
	SOCHIEU INT,
	MALOAI NCHAR(15) NOT NULL,
	NOISANXUAT NVARCHAR(30),
	MOTA NVARCHAR(30),
	ANHBIA NCHAR(30),
	SOLUONG INT,
	NGAYNHAP DATE,
	CONSTRAINT PK_SANPHAM PRIMARY KEY (MASP),
	CONSTRAINT FK_SANPHAM_MALOAI FOREIGN KEY (MALOAI) REFERENCES LOAISP(MALOAI)
)

CREATE TABLE KHACHHANG
(
	MAKH NCHAR(15) NOT NULL,
	TENKH NVARCHAR(30),
	SDT NCHAR(10),
	DIACHI NVARCHAR(30),
	CONSTRAINT PK_KHACHHANG PRIMARY KEY (MAKH)
)

CREATE TABLE HOADONKH
(
	MAHD NCHAR(15) NOT NULL,
	MAKH NCHAR(15) NOT NULL,
	NGAY DATE, 
	TONGTIEN FLOAT, 
	TONGSOLUONGSPDAMUA int 
	CONSTRAINT PK_HOADONKH PRIMARY KEY (MAHD),
	CONSTRAINT FK_HOADONKH_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
)

CREATE TABLE CHITIETHOADONKH
(
	MAHD NCHAR(15) NOT NULL,
	MASP NCHAR(15) NOT NULL,
	SOLUONG INT,
	CONSTRAINT PK_CHITIETHOADONKH PRIMARY KEY (MAHD, MASP),
	CONSTRAINT FK_CHITIETHOADONKH_HOADONKH FOREIGN KEY (MAHD) REFERENCES HOADONKH(MAHD),
	CONSTRAINT FK_CHITIETHOADONKH_SANPHAM FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)
)

CREATE TABLE THONGKE
(
	STT INT IDENTITY(1,1) NOT NULL,
	SOKHACH1NGAY INT,
	TONGTIENBANDUOCTRONGNGAY FLOAT,
	NGAY DATE,
	CONSTRAINT PK_THONGKE PRIMARY KEY (STT)
)


CREATE TABLE CHITIETTHONGKE
(
	MAHD NCHAR(15) NOT NULL,
	STT INT NOT NULL,
	CONSTRAINT PK_CHITIETTHONGKE PRIMARY KEY (MAHD, STT),
	CONSTRAINT FK_CHITIETTHONGKE_HOADONKH FOREIGN KEY (MAHD) REFERENCES HOADONKH(MAHD),
	CONSTRAINT FK_CHITIETTHONGKE_THONGKE FOREIGN KEY (STT) REFERENCES THONGKE(STT)
)

CREATE TABLE NHANVIEN
(
	MANV NCHAR(15) NOT NULL,
	TENNV NVARCHAR(30),
	GIOI NVARCHAR(4) CHECK(GIOI=N'Nam' OR GIOI=N'Nữ') DEFAULT 'Nam',
	DIACHI NVARCHAR(30) NOT NULL DEFAULT'',
	NGAYSINH DATE,
	CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANV)
)

CREATE TABLE DONVIVANCHUYEN
(
	MANV NCHAR(15) NOT NULL,
	MASP NCHAR(15) NOT NULL,
	NGAYGIAO DATE,
	DIACHIGIAOHANG NVARCHAR(30) NOT NULL DEFAULT'',
	CONSTRAINT PK_DONVIVANCHUYEN PRIMARY KEY (MANV, MASP,NGAYGIAO),
	CONSTRAINT FK_DONVIVANCHUYEN_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
	CONSTRAINT FK_DONVIVANCHUYEN_SANPHAM FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)
)

CREATE TABLE NHOMQUYEN
(
	IDNHOMQUYEN char(5) not null,
	TENNHOMQUYEN nvarchar(20),
	CONSTRAINT PK_NHOMQUYEN PRIMARY KEY (IDNHOMQUYEN)
)

CREATE TABLE NGUOIDUNG
(
	IDUSER char(5) not null,
	HOTEN nvarchar(30),
	SDT char(10),
	EMAIL nvarchar(20),
	TENTAIKHOAN char(20),
	MATKHAU char(20),
	IDNHOMQUYEN char(5)
	CONSTRAINT PK_NGUOIDUNG PRIMARY KEY (IDUSER)
	CONSTRAINT FK_NGUOIDUNG_NHOMQUYEN FOREIGN KEY (IDNHOMQUYEN) REFERENCES NHOMQUYEN(IDNHOMQUYEN)
)

CREATE TABLE QUYEN
(
	IDQUYEN char(5) not null,
	IDNHOMQUYEN char(5),
	QUYENHAN nvarchar(20),
	CONSTRAINT PK_QUYEN PRIMARY KEY (IDQUYEN),
	CONSTRAINT FK_QUYEN_NHOMQUYEN FOREIGN KEY (IDNHOMQUYEN) REFERENCES NHOMQUYEN(IDNHOMQUYEN)
)

INSERT INTO NHASANXUAT VALUES
('Sam','SamSung'),
('Pan','Panasonic'),
('Tos','Toshiba'),
('Dai','Daikin')

INSERT INTO LOAISP VALUES
('AirC-1',N'Máy lạnh treo tường','Sam'),
('AirC-2',N'Máy lạnh tủ đứng','Pan'),
('AirC-3',N'Máy lạnh âm trần','Tos'),
('AirC-4',N'Máy lạnh giấu trần nối ống gió','Dai')

SET DATEFORMAT DMY
INSERT INTO SANPHAM VALUES
('SP-1','Panasonic YZ9WKYH-8 Interver',7440000,7400000,'1 HP – 8700 BTU',1,'AirC-1','Malaysia',NULL,'Hinh1.png',10,'11/10/2019'),
('SP-2','Daikin FTKB25WVMV Interver',10990000,10000000,'1 HP – 8500 BTU',2,'AirC-2',N'Việt Nam',NULL,'Hinh2.png',10,'15/10/2020'),
('SP-3','Daikin FTHF50VV\MV Interver',24090000,24000000,'2 HP – 17.100 BTU',2,'AirC-3',N'Thái Lan',NULL,'Hinh3.png',10,'3/5/2018'),
('SP-4','Toshiba RAS-H13C4CVG Interver',12990000,12000000,'1.5 HP – 15.000BTU',1,'AirC-4',N'Thái Lan',NULL,'Hinh4.png',10,'1/2/2011'),
('SP-5','Toshiba RAS-H19C3KCVG Interver',18900000,18000000,'2 HP – 17.100 BTU',2,'AirC-4',N'Thái Lan',NULL,'Hinh5.png',10,'5/7/2019'),
('SP-6','SamSung AR09TYQASINS Interver',7990000,7000000,'1 HP – 9000 BTU',2,'AirC-3',N'Trung Quốc',NULL,'Hinh5.png',10,'17/12/2021'),
('SP-7','SamSung AR13TYYCWKNS Interver',11790000,11000000,'1.5 HP – 12000 BTU',2,'AirC-1',N'Thái Lan',NULL,'Hinh4.png',10,'28/12/2022'),
('SP-8','LG V10NH1 Interver',9190000,9100000,'1 HP - 9200 BTU',1,'AirC-2',N'Thái Lan',NULL,'Hinh3.png',10,'6/3/2022'),
('SP-9','LG V13PFUV Interver',16600000,16000000,'1.5 HP - 11.200 BTU',1,'AirC-3',N'Thái Lan',NULL,'Hinh2.png',10,'9/8/2018'),
('SP-10','Aqua AQA-KCRV10TK Interver',8890000,8800000,'1 HP - 9.200 BTU',2,'AirC-4',N'Việt Nam',NULL,'Hinh1.png',10,'7/11/2019'),
('SP-11','TCL TAC-10CS/KE88N Interver',7990000,7900000,'1 HP - 9.000 BTU',2,'AirC-2','Indonesia',NULL,'Hinh1.png',10,'1/1/2021'),
('SP-12','Kangaroo KGAC12I Interver',9690000,9600000,'1.5 HP - 12.000 BTU',2,'AirC-3',N'Thái Lan',NULL,'Hinh2.png',10,'9/5/2020'),
('SP-13','Panasonic CS-PU9KH-8M Interver',11390000,11000000,'1 HP – 9040 BTU',1,'AirC-1','Malaysia',NULL,'Hinh3.png',10,'21/12/2022')

select * from CHITIETHOADONKH

INSERT INTO KHACHHANG VALUES
('KH-123',N'Nguyễn Văn Bình','0888013460','TP.HCM'),
('KH-456',N'Lê Thị Thủy','0924224675','Long An'),
('KH-789',N'Trần Thanh Tuấn','0919698351',N'Tiền Giang'),
('KH-321',N'Dương Thanh Tài','0336670451',N'Phú Yên'),
('KH-654',N'Nguyễn Ngọc Thảo','0123889124',N'Bình Phước'),
('KH-987',N'Nguyễn Duy Quang','0945772391','Đà Lạt')

SET DATEFORMAT DMY
INSERT INTO HOADONKH VALUES
('HD-1','KH-123','12/07/2022',0,0),
('HD-2','KH-456','02/09/2022',0,0),
('HD-3','KH-789','20/10/2022',0,0),
('HD-4','KH-321','12/07/2022',0,0),
('HD-5','KH-654','20/10/2022',0,0),
('HD-6','KH-987','12/07/2022',0,0)


INSERT INTO CHITIETHOADONKH VALUES
('HD-1','SP-1',2),
('HD-2','SP-7',5),
('HD-3','SP-5',1),
('HD-4','SP-4',1),
('HD-5','SP-6',3),
('HD-6','SP-8',4)

--SET DATEFORMAT DMY
--INSERT INTO THONGKE VALUES
--(1,3,72530000,'12/07/2022'),
--(2,1,58950000,'02/09/2022'),
--(3,2,42870000,'20/10/2022'),
--(4,0,0,'14/08/2022')

--INSERT INTO CHITIETTHONGKE VALUES
--(123,1),
--(456,2),
--(789,3)

SET DATEFORMAT DMY
INSERT INTO NHANVIEN VALUES
('NV01',N'Lê Thanh Nam','Nam','TP.HCM','24/06/2001'),
('NV02',N'Nguyễn Nhựt Tân','Nam','Tiền Giang','12/05/2002'),
('NV03',N'Nguyễn Ngọc Thảo',N'Nữ','Bình Phước','16/02/2002'),
('NV04',N'Nguyễn Quan Vinh','Nam','Phú Yên','29/06/2001')

SET DATEFORMAT DMY
INSERT INTO DONVIVANCHUYEN VALUES
('NV04','SP-1','12/07/2022',N'Hà Nội'),
('NV01','SP-4','02/09/2022','TP.HCM'),
('NV02','SP-6','20/10/2022','Bình Dương')

INSERT INTO NHOMQUYEN VALUES 
('QT', N'Quản trị'),
('NV', N'Nhân viên')

INSERT INTO QUYEN VALUES
(1,'NV',N'Tạo sản phẩm'),
(2,'NV',N'Thống kê'),
(3,'NV',N'Danh sách sản phẩm'),
(4,'QT',N'Tất cả')

INSERT INTO NGUOIDUNG VALUES
('user1',N'Trịnh Lê Hoàng Dũ', '0336670451', 'dutrinh@gmail.com', 'Admin', '123', 'QT'),
('user2',N'Bùi Đức Tài', '0383220237', 'ductai@gmail.com', 'ductai', '123', 'NV')

select * from NGUOIDUNG


---------------------------Hàm biểu đồ------------------------------------
create function F_TK_TienTungSanPham(@START INT,@FINISH INT)
returns @DS2 table(MASP NCHAR(30),TENSP NVARCHAR(50),THANHTIEN FLOAT)
AS
	BEGIN
		DECLARE @MASP NCHAR(30),@TENSP NVARCHAR(50),@THANHTIEN FLOAT
		DECLARE CS_DS2 cursor FOR SELECT MASP,TENSP FROM SANPHAM
		OPEN CS_DS2
		FETCH NEXT FROM CS_DS2 INTO @MASP,@TENSP
		WHILE(@@FETCH_STATUS=0)
			BEGIN
				SET @THANHTIEN=(SELECT SUM(CT.SOLUONG *(DONGIA-GIAGOC)) FROM CHITIETHOADONKH CT,HOADONKH HD,SANPHAM SP WHERE CT.MASP=@MASP AND SP.MASP=CT.MASP AND HD.MAHD=CT.MAHD AND YEAR(NGAY) BETWEEN @START AND @FINISH)
				IF(@THANHTIEN IS NULL)
					SET @THANHTIEN=0
				INSERT INTO @DS2 VALUES(@MASP,@TENSP,@THANHTIEN)
				FETCH NEXT FROM CS_DS2 INTO @MASP,@TENSP
			END
		CLOSE CS_DS2
		DEALLOCATE CS_DS2
		return
	END
select * from CHITIETHOADONKH

---------------------------Hàm biểu đồ------------------------------------
create function F_TK_SLTungSanPham(@START INT,@FINISH INT)
returns @DS3 table(MASP NCHAR(30),TENSP NVARCHAR(50),SOLUONG INT)
AS
	BEGIN
		DECLARE @MASP NCHAR(30),@TENSP NVARCHAR(50),@SOLUONG INT
		DECLARE CS_DS3 cursor FOR SELECT MASP,TENSP FROM SANPHAM
		OPEN CS_DS3
		FETCH NEXT FROM CS_DS3 INTO @MASP,@TENSP
		WHILE(@@FETCH_STATUS=0)
			BEGIN
				SET @SOLUONG=(SELECT SUM(SOLUONG) FROM CHITIETHOADONKH CT,HOADONKH HD WHERE MASP=@MASP AND HD.MAHD=CT.MAHD AND YEAR(NGAY) BETWEEN @START AND @FINISH)
				IF(@SOLUONG IS NULL)
					SET @SOLUONG=0
				INSERT INTO @DS3 VALUES(@MASP,@TENSP,@SOLUONG)
				FETCH NEXT FROM CS_DS3 INTO @MASP,@TENSP
			END
		CLOSE CS_DS3
		DEALLOCATE CS_DS3
		return
	END


---------------------------Hàm biểu đồ------------------------------------
create function F_TK_TienTungLoai(@START INT,@FINISH INT)
returns @DS4 table(MALOAI NCHAR(30),TENLOAI NVARCHAR(50),THANHTIEN FLOAT)
AS
	BEGIN
		DECLARE @MALOAI NCHAR(30),@TENLOAI NVARCHAR(50),@THANHTIEN FLOAT
		DECLARE CS_DS4 cursor FOR SELECT MALOAI,TENLOAI FROM LOAISP
		OPEN CS_DS4
		FETCH NEXT FROM CS_DS4 INTO @MALOAI,@TENLOAI
		WHILE(@@FETCH_STATUS=0)
			BEGIN
				SET @THANHTIEN=(SELECT SUM(CT.SOLUONG*(S.DONGIA-GIAGOC)) FROM CHITIETHOADONKH CT,HOADONKH HD,LOAISP L,SANPHAM S WHERE HD.MAHD=CT.MAHD AND YEAR(NGAY) BETWEEN @START AND @FINISH AND @MALOAI=L.MALOAI AND S.MASP=CT.MASP AND S.MALOAI=L.MALOAI)
				IF(@THANHTIEN IS NULL)
					SET @THANHTIEN=0
				INSERT INTO @DS4 VALUES(@MALOAI,@TENLOAI,@THANHTIEN)
				FETCH NEXT FROM CS_DS4 INTO @MALOAI,@TENLOAI
			END
		CLOSE CS_DS4
		DEALLOCATE CS_DS4
		return
	END

--1/ Viết thủ tục cập nhật TONGTIEN trong bảng HOADONKH

CREATE PROC updateTONGTIEN
AS
	BEGIN
		UPDATE HOADONKH
		SET TONGTIEN = (SELECT SUM(ct.SOLUONG*DONGIA) FROM CHITIETHOADONKH ct, SANPHAM sp WHERE HOADONKH.MAHD=ct.MAHD AND ct.MASP=sp.MASP)
	END

EXEC updateTONGTIEN

--2/Để kiểm tra một khách hàng thuộc loại nào (‘VIP’, ‘KH thành viên’, ‘KH thân thiết’)
--cần viết một thủ tục truyền vào tham sô ma khách hàng sẽ trả về ‘VIP’ nếu
--doanh sô ≥10.000.000; ‘KH thành viên’ nếu 6.000.000 ≤ doanh sô <10.000.000; ‘KH
--thân thiết’ nếu doanh sô <6.000.000 (ghi chú: Doanh sô là sô tiền mà khách mua hàng)

CREATE PROC KiemTra @MAKH char(10)
AS
	BEGIN
		IF NOT EXISTS (SELECT MAKH FROM KHACHHANG WHERE MAKH=@MAKH)
			PRINT N'Không có mã khách hàng này'
		ELSE
		BEGIN
			DECLARE @TIEN FLOAT
			SET @TIEN = (SELECT SUM(TONGTIEN) FROM HOADONKH WHERE MAKH=@MAKH)
			IF(@TIEN >= 10000000)
				PRINT N'Khách Hàng VIP'
			ELSE IF(@TIEN >= 6000000)
				PRINT N'Khách Hàng thành viên'
			ELSE
				PRINT N'Khách Hàng thân thiết'
		END
	END
EXEC KiemTra 'KH-123'

--3/ Viết thủ tục truyền vào tham sô mã loai sẽ trả về tên nhà cung cấp tương ứng.
CREATE PROC TraVeTenNhaCungCap @MALOAI NCHAR(15)
AS
	BEGIN
		DECLARE @TENNSX NVARCHAR(30)
		IF NOT EXISTS (SELECT * FROM LOAISP WHERE MALOAI=@MALOAI)
			PRINT N'Sản phẩm này không tồn tại'
		ELSE
			SET @TENNSX =(SELECT TENNSX FROM LOAISP, NHASANXUAT WHERE NHASANXUAT.MANSX=LOAISP.MANSX AND MALOAI=@MALOAI)
			PRINT N'Tên nhà sản xuất là: ' + @TENNSX
	END
EXEC TraVeTenNhaCungCap 'AirC-1'

--4/Viết trigger cập nhật bảng thống kê từ bảng hóa đơn khi có một hóa dơn được insert
create trigger CapNhatThongKe_INSERT on HOADONKH
FOR INSERT
AS
	BEGIN
		declare CS_CapNhatThongKe CURSOR FOR SELECT TONGTIEN,NGAY FROM inserted
		OPEN CS_CapNhatThongKe
		declare @TongTienHD float,@Ngay date
		FETCH NEXT FROM CS_CapNhatThongKe INTO @TongTienHD,@Ngay
		--set @TongTienHD=(select TONGTIEN from inserted)
		--set @Ngay=(select NGAY from inserted)
		while( @@FETCH_STATUS=0)
			begin
				IF NOT EXISTS(SELECT * FROM THONGKE T WHERE @Ngay=T.NGAY)
					insert into THONGKE(SOKHACH1NGAY,TONGTIENBANDUOCTRONGNGAY,NGAY) values(1,@TongTienHD,@Ngay)
				else
					begin
						update THONGKE
						set SOKHACH1NGAY=SOKHACH1NGAY+1,TONGTIENBANDUOCTRONGNGAY=TONGTIENBANDUOCTRONGNGAY+@TongTienHD
						where NGAY=@Ngay
					end
				FETCH NEXT FROM CS_CapNhatThongKe INTO @TongTienHD,@Ngay
			end
		close CS_CapNhatThongKe
		deallocate CS_CapNhatThongKe
	end

create trigger CapNhatThongKe_UPDATE on HOADONKH
FOR UPDATE
AS
	BEGIN
		declare CS_CapNhatThongKe CURSOR FOR SELECT TONGTIEN,NGAY FROM deleted
		OPEN CS_CapNhatThongKe
		declare @TongTienHD float,@Ngay date
		FETCH NEXT FROM CS_CapNhatThongKe INTO @TongTienHD,@Ngay
		while( @@FETCH_STATUS=0)
			begin
				update THONGKE
				set TONGTIENBANDUOCTRONGNGAY=TONGTIENBANDUOCTRONGNGAY-@TongTienHD+(SELECT TONGTIEN FROM inserted)
				where NGAY=@Ngay
				FETCH NEXT FROM CS_CapNhatThongKe INTO @TongTienHD,@Ngay
			end
		close CS_CapNhatThongKe
		deallocate CS_CapNhatThongKe
	end
--5 hàm nội tuyến trả về tenloai, maloai,tensp truyền vào mansx
CREATE FUNCTION X_MANSX(@MANSX NCHAR(15))
RETURNS @SP TABLE(MALOAI NCHAR(15),TENLOAI NVARCHAR(30),TENSP NVARCHAR(30))
AS
BEGIN
 return
END
--6/Viết thủ tục truyền vào MASP ,kiểm tra sản phẩm đó có được bán chưa nếu có thì in 
--là so lượng đã bán, nguoc lại thì in ‘San Phẩm chua bán được’
CREATE PROC KiemTraTinhTrangBan1 @TENSP nvarchar(30)
AS
	BEGIN
		IF NOT EXISTS (SELECT * FROM SANPHAM WHERE TENSP=@TENSP)
			PRINT N'Không tìm thấy sản phẩm'
		ELSE
			BEGIN
				DECLARE @sl int
				SET @sl = (SELECT SUM(ct.SOLUONG) FROM CHITIETHOADONKH ct, SANPHAM sp 
							WHERE sp.MASP = ct.MASP and TENSP=@TENSP)
				IF @sl IS NULL
					PRINT N'Sản phẩm chưa bán được'
				ELSE
					PRINT N'Số lượng sản phẩm đã bán được là ' + convert(char,@sl)
			END
	END
--7/Viết hàm trả về THANHTIEN là tổng tiền mà sản phẩm đó bán được  
create function f_TongTienSanPham(@MASP NCHAR(15))
returns float
AS
	BEGIN
		DECLARE @SOLUONG FLOAT=(SELECT SUM(CT.SOLUONG) FROM CHITIETHOADONKH CT WHERE CT.MASP=@MASP)
		return @SOLUONG*(SELECT DONGIA FROM SANPHAM WHERE MASP=@MASP)
	END
--8/ Viết hàm trả về SOLUONG là tổng số lượng mà sản phẩm đó bán được ngược lại nếu ko 
--bán được thì in ‘San Phẩm chua bán được’, với tham số truyền vào MASP 
CREATE PROC KiemTraTinhTrangBan @MASP nchar(15)
AS
	BEGIN
		IF NOT EXISTS (SELECT * FROM SANPHAM WHERE MASP=@MASP)
			PRINT N'Không tìm thấy sản phẩm'
		ELSE
			BEGIN
				DECLARE @sl int
				SET @sl = (SELECT SUM(SOLUONG) FROM CHITIETHOADONKH WHERE MASP=@MASP)
				IF @sl IS NULL
					PRINT N'Sản phẩm chưa bán được'
				ELSE
					PRINT N'Số lượng sản phẩm đã bán được là ' + convert(char,@sl)
			END
	END
--9/ Viết hàm trả về THANHTIEN là tổng tiền mà loại  đó bán được  ngược lại nếu ko bán 
--được thì in ‘loại chua bán được’, với tham số truyền vào MALOAI 
CREATE PROC TONGTIENMOTLOAISP @MASP nchar(10)
AS
	BEGIN
		IF NOT EXISTS (SELECT * FROM SANPHAM WHERE MASP = @MASP)
			PRINT N'Không tìm thấy sản phẩm'
		ELSE
			BEGIN
				DECLARE @TT int
				SET @TT = (SELECT DONGIA FROM CHITIETHOADONKH ct, SANPHAM sp 
							WHERE sp.MASP = ct.MASP  and ct.MASP = @MASP) * (SELECT SOLUONG FROM CHITIETHOADONKH WHERE MASP=@MASP)
				IF @TT IS NULL
					PRINT N'Loại chưa bán được'
				ELSE
					PRINT N'Thành tiền của sản phẩm có mã ' +@MASP+ N' là ' + convert(char,@TT)
			END
	END
--10/ Viết thủ tục in ra sản phẩm được bán nhiều nhất
CREATE PROC MAX_SANPHAM
AS
	BEGIN
		DECLARE  @TENSP NVARCHAR(30)
		SET @TENSP=(SELECT TENSP 
					FROM SANPHAM, CHITIETHOADONKH
					WHERE SANPHAM.MASP=CHITIETHOADONKH.MASP 
					GROUP BY TENSP
					HAVING  SUM(CHITIETHOADONKH.SOLUONG)>= ALL(SELECT SUM(CHITIETHOADONKH.SOLUONG) FROM CHITIETHOADONKH GROUP BY MASP) )
		PRINT N'Sản phẩm được bán nhiều nhất là: ' +@TENSP
	END
EXEC MAX_SANPHAM

--11/Viết trigger cập nhật thành tiền của hóa đon khi 1 chi tiet hoa don được insert
create trigger CapNhatThanhTien on CHITIETHOADONKH
for insert
as	
	BEGIN
		DECLARE CS_CapNhatThanhTien CURSOR FOR SELECT MAHD,MASP,SOLUONG FROM inserted
		OPEN CS_CapNhatThanhTien
		DECLARE @SOLUONGSP INT,@MASP VARCHAR(15),@MAHD NCHAR(15)
		FETCH NEXT FROM CS_CapNhatThanhTien INTO @MAHD,@MASP,@SOLUONGSP
		WHILE(@@FETCH_STATUS=0)
			BEGIN
				UPDATE HOADONKH
				SET TONGTIEN =TONGTIEN+@SOLUONGSP*(select DONGIA from SANPHAM where MASP=@MASP),TONGSOLUONGSPDAMUA=TONGSOLUONGSPDAMUA+@SOLUONGSP
				WHERE MAHD=@MAHD
				FETCH NEXT FROM CS_CapNhatThanhTien INTO @MAHD,@MASP,@SOLUONGSP
			END
		close CS_CapNhatThanhTien
		deallocate CS_CapNhatThanhTien
	END

--12/Viết trigger cập nhật số lượng sản phẩm còn lai trong bảng SANPHAM 
--khi một sản phẩm được bán trong chi tiết hóa đơn
create trigger CapNhatSLSanPham on CHITIETHOADONKH
FOR INSERT
AS
	BEGIN
		DECLARE CS_CapNhatSLSanPham CURSOR FOR SELECT MASP,SOLUONG FROM inserted
		DECLARE @MASP NCHAR(15),@SOLUONG INT
		OPEN  CS_CapNhatSLSanPham
		FETCH NEXT FROM  CS_CapNhatSLSanPham INTO @MASP,@SOLUONG
		WHILE(@@FETCH_STATUS=0)
			BEGIN
				update SANPHAM
				SET SOLUONG=SOLUONG-@SOLUONG
				WHERE MASP=@MASP
				FETCH NEXT FROM  CS_CapNhatSLSanPham INTO @MASP,@SOLUONG
			END
		CLOSE CS_CapNhatSLSanPham
		DEALLOCATE CS_CapNhatSLSanPham
	END